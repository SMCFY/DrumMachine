<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="30,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">classdef</span> impactSynth &lt; audioPlugin</span></span>
<span class="srcline"><span class="lineno"><a href="30,2" id="srcline2">  2</a></span><span class="line">    <span class="comment">% audio plugin for producing bubble sounds</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,3" id="srcline3">  3</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,4" id="srcline4">  4</a></span><span class="line">    <span class="keyword">properties</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,5" id="srcline5">  5</a></span><span class="line">        <span class="comment">% interfaced parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,6" id="srcline6">  6</a></span><span class="line">        strikePos = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="30,7" id="srcline7">  7</a></span><span class="line">        strikeVig = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="30,8" id="srcline8">  8</a></span><span class="line">        dimension = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="30,9" id="srcline9">  9</a></span><span class="line">        material = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="30,10" id="srcline10"> 10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,11" id="srcline11"> 11</a></span><span class="line">        instID = 1; <span class="comment">% instrument ID</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,12" id="srcline12"> 12</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,13" id="srcline13"> 13</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,14" id="srcline14"> 14</a></span><span class="line">    <span class="keyword">properties</span> (Dependent)</span></span>
<span class="srcline"><span class="lineno"><a href="30,15" id="srcline15"> 15</a></span><span class="line">        trig = <span class="string">'noteOff'</span>; <span class="comment">% noteState</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,16" id="srcline16"> 16</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,17" id="srcline17"> 17</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,18" id="srcline18"> 18</a></span><span class="line">    <span class="keyword">properties</span> (Access = private)</span></span>
<span class="srcline"><span class="lineno"><a href="30,19" id="srcline19"> 19</a></span><span class="line">        <span class="comment">% vst parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,20" id="srcline20"> 20</a></span><span class="line">        fs; <span class="comment">% sampling rate</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,21" id="srcline21"> 21</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,22" id="srcline22"> 22</a></span><span class="line">        buff; <span class="comment">% buffer for generated waveform</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,23" id="srcline23"> 23</a></span><span class="line">        t = 2; <span class="comment">% buffer length in seconds</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,24" id="srcline24"> 24</a></span><span class="line">        readIndex = [1; 1; 1; 1]; <span class="comment">% reading position in buffers</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,25" id="srcline25"> 25</a></span><span class="line">        soundOut = [0; 0; 0; 0]; <span class="comment">% state variable decides whether to output the signal from the buffer or not</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,27" id="srcline27"> 27</a></span><span class="line">        frameBuff; <span class="comment">% buffer for output frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,28" id="srcline28"> 28</a></span><span class="line">        maxFrameSize; <span class="comment">% maximum frame size in samples</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,29" id="srcline29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,30" id="srcline30"> 30</a></span><span class="line">        noteState = <span class="string">'noteOff'</span>; <span class="comment">% trig</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,32" id="srcline32"> 32</a></span><span class="line">        <span class="comment">%=================================== synth parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,33" id="srcline33"> 33</a></span><span class="line">        modes = [112, 203, 259, 279, 300, 332, 345, 375, 398, 407, 450, 473, 488, 488, 547, 596,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,34" id="srcline34"> 34</a></span><span class="line">                 625, 653, 679, 692, 705, 760, 773, 806, 852, 899, 924, 975, 998, 1019, 1046, 1109,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,35" id="srcline35"> 35</a></span><span class="line">                 1134, 1164, 1192, 1226, 1309, 1358, 1379, 1411, 1461, 1532, 1610, 1683, 1758, 1880,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,36" id="srcline36"> 36</a></span><span class="line">                 2027, 2131, 2271, 2515, 2731, 2809, 2922, 3224, 4694];</span></span>
<span class="srcline"><span class="lineno"><a href="30,37" id="srcline37"> 37</a></span><span class="line">        decay = [0.9999 0.9999 0.9998 0.9998 0.9998 0.9997 0.9997 0.9996 0.9996 0.9995<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,38" id="srcline38"> 38</a></span><span class="line">                 0.9995 0.9994 0.9994 0.9993 0.9993 0.9992 0.9992 0.9991 0.9991 0.999 0.999<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,39" id="srcline39"> 39</a></span><span class="line">                 0.998 0.998 0.997 0.997 0.996 0.996 0.995 0.995 0.994 0.994 0.993<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,40" id="srcline40"> 40</a></span><span class="line">                 0.993 0.992 0.992 0.991 0.991 0.991 0.991 0.991 0.991 0.991 0.991 0.991 0.99<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,41" id="srcline41"> 41</a></span><span class="line">                 0.993 0.992 0.991 0.99 0.98 0.98 0.98 0.97 0.97 0.97];</span></span>
<span class="srcline"><span class="lineno"><a href="30,42" id="srcline42"> 42</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,43" id="srcline43"> 43</a></span><span class="line">        lpfPole = 0.5; <span class="comment">% lowpass filter pole radius - loss filter damping</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,44" id="srcline44"> 44</a></span><span class="line">        excGain = 0.5; <span class="comment">% gain coefficient for the excitation</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,45" id="srcline45"> 45</a></span><span class="line">        strikeGain; <span class="comment">% gain coefficient for each mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,46" id="srcline46"> 46</a></span><span class="line">        m = 0; <span class="comment">% slope of transfer fuction</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,47" id="srcline47"> 47</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,48" id="srcline48"> 48</a></span><span class="line">        resBank = [audioread(<span class="string">'Analyses/tom_res.wav'</span>)'; <span class="comment">% extracted residuals</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,49" id="srcline49"> 49</a></span><span class="line">                   audioread(<span class="string">'Analyses/snare_res.wav'</span>)';</span></span>
<span class="srcline"><span class="lineno"><a href="30,50" id="srcline50"> 50</a></span><span class="line">                   audioread(<span class="string">'Analyses/cymbal_res.wav'</span>)';</span></span>
<span class="srcline"><span class="lineno"><a href="30,51" id="srcline51"> 51</a></span><span class="line">                   audioread(<span class="string">'Analyses/kick_res.wav'</span>)'];</span></span>
<span class="srcline"><span class="lineno"><a href="30,52" id="srcline52"> 52</a></span><span class="line">        resPadded; <span class="comment">% zero padded residuals</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,53" id="srcline53"> 53</a></span><span class="line">        <span class="comment">%===================================</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,54" id="srcline54"> 54</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,55" id="srcline55"> 55</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,56" id="srcline56"> 56</a></span><span class="line">    <span class="keyword">properties</span> (Constant)</span></span>
<span class="srcline"><span class="lineno"><a href="30,57" id="srcline57"> 57</a></span><span class="line">       PluginInterface = audioPluginInterface(<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,58" id="srcline58"> 58</a></span><span class="line">           audioPluginParameter(<span class="string">'strikePos'</span>,<span class="string">'DisplayName'</span>,<span class="string">'StrikePosition'</span>,<span class="string">'Mapping'</span>,{<span class="string">'lin'</span>,0,1}),<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,59" id="srcline59"> 59</a></span><span class="line">           audioPluginParameter(<span class="string">'strikeVig'</span>,<span class="string">'DisplayName'</span>,<span class="string">'StrikeVigor'</span>,<span class="string">'Mapping'</span>,{<span class="string">'lin'</span>,0,1}),<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,60" id="srcline60"> 60</a></span><span class="line">           audioPluginParameter(<span class="string">'dimension'</span>,<span class="string">'DisplayName'</span>,<span class="string">'Dimension'</span>,<span class="string">'Mapping'</span>,{<span class="string">'lin'</span>,0.5,1.5}),<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,61" id="srcline61"> 61</a></span><span class="line">           audioPluginParameter(<span class="string">'material'</span>,<span class="string">'DisplayName'</span>,<span class="string">'Material'</span>,<span class="string">'Mapping'</span>,{<span class="string">'lin'</span>,0,1}),<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,62" id="srcline62"> 62</a></span><span class="line">           audioPluginParameter(<span class="string">'instID'</span>,<span class="string">'DisplayName'</span>,<span class="string">'ID'</span>,<span class="string">'Mapping'</span>,{<span class="string">'int'</span>,1,4}),<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,63" id="srcline63"> 63</a></span><span class="line">           audioPluginParameter(<span class="string">'trig'</span>,<span class="string">'DisplayName'</span>,<span class="string">'Trigger'</span>,<span class="string">'Mapping'</span>,{<span class="string">'enum'</span>,<span class="string">'noteOff'</span>,<span class="string">'noteOn_'</span>}),<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,64" id="srcline64"> 64</a></span><span class="line">           <span class="string">'InputChannels'</span>,1,<span class="string">'OutputChannels'</span>,1);      </span></span>
<span class="srcline"><span class="lineno"><a href="30,65" id="srcline65"> 65</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%--------------------------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,67" id="srcline67"> 67</a></span><span class="line">    <span class="keyword">methods</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,68" id="srcline68"> 68</a></span><span class="line">        <span class="keyword">function</span> obj = impactSynth() <span class="comment">% constructor</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,69" id="srcline69"> 69</a></span><span class="line">            obj.fs = getSampleRate(obj);</span></span>
<span class="srcline"><span class="lineno"><a href="30,70" id="srcline70"> 70</a></span><span class="line">            obj.maxFrameSize = 16384; <span class="comment">% 2^14</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,71" id="srcline71"> 71</a></span><span class="line">            obj.buff = [zeros(1,obj.fs*obj.t);</span></span>
<span class="srcline"><span class="lineno"><a href="30,72" id="srcline72"> 72</a></span><span class="line">                        zeros(1,obj.fs*obj.t);</span></span>
<span class="srcline"><span class="lineno"><a href="30,73" id="srcline73"> 73</a></span><span class="line">                        zeros(1,obj.fs*obj.t);</span></span>
<span class="srcline"><span class="lineno"><a href="30,74" id="srcline74"> 74</a></span><span class="line">                        zeros(1,obj.fs*obj.t)];</span></span>
<span class="srcline"><span class="lineno"><a href="30,75" id="srcline75"> 75</a></span><span class="line">            obj.frameBuff = zeros(1,obj.maxFrameSize);</span></span>
<span class="srcline"><span class="lineno"><a href="30,76" id="srcline76"> 76</a></span><span class="line">            obj.strikeGain = ones(1,length(obj.modes(1,:)));</span></span>
<span class="srcline"><span class="lineno"><a href="30,77" id="srcline77"> 77</a></span><span class="line">            obj.resPadded = [obj.resBank(1,:), zeros(1, obj.fs*obj.t-length(obj.resBank(1,:)));</span></span>
<span class="srcline"><span class="lineno"><a href="30,78" id="srcline78"> 78</a></span><span class="line">                             obj.resBank(2,:), zeros(1, obj.fs*obj.t-length(obj.resBank(2,:)));</span></span>
<span class="srcline"><span class="lineno"><a href="30,79" id="srcline79"> 79</a></span><span class="line">                             obj.resBank(3,:), zeros(1, obj.fs*obj.t-length(obj.resBank(3,:)));</span></span>
<span class="srcline"><span class="lineno"><a href="30,80" id="srcline80"> 80</a></span><span class="line">                             obj.resBank(4,:), zeros(1, obj.fs*obj.t-length(obj.resBank(4,:)));];</span></span>
<span class="srcline"><span class="lineno"><a href="30,81" id="srcline81"> 81</a></span><span class="line">        <span class="keyword">end</span>                                   </span></span>
<span class="srcline"><span class="lineno"><a href="30,82" id="srcline82"> 82</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,83" id="srcline83"> 83</a></span><span class="line">        <span class="keyword">function</span> reset(obj)</span></span>
<span class="srcline"><span class="lineno"><a href="30,84" id="srcline84"> 84</a></span><span class="line">            obj.readIndex = [1; 1; 1; 1];</span></span>
<span class="srcline"><span class="lineno"><a href="30,85" id="srcline85"> 85</a></span><span class="line">            obj.soundOut = [0; 0; 0; 0];</span></span>
<span class="srcline"><span class="lineno"><a href="30,86" id="srcline86"> 86</a></span><span class="line">        <span class="keyword">end</span> </span></span>
<span class="srcline"><span class="lineno"><a href="30,87" id="srcline87"> 87</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,88" id="srcline88"> 88</a></span><span class="line">        <span class="keyword">function</span> set.trig(obj, val)</span></span>
<span class="srcline"><span class="lineno"><a href="30,89" id="srcline89"> 89</a></span><span class="line">            <span class="keyword">if</span> val == <span class="string">'noteOn_'</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,90" id="srcline90"> 90</a></span><span class="line">                obj.readIndex(obj.instID) = 1; <span class="comment">% init readIndex of respective buffer</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,91" id="srcline91"> 91</a></span><span class="line">                obj.soundOut(obj.instID) = 1; <span class="comment">% trigger sound according to instrument ID</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,92" id="srcline92"> 92</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,93" id="srcline93"> 93</a></span><span class="line">                <span class="comment">%=================================== sound synthesis</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,94" id="srcline94"> 94</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="30,95" id="srcline95"> 95</a></span><span class="line">                obj.lpfPole = abs(obj.material-0.001); <span class="comment">% material</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,96" id="srcline96"> 96</a></span><span class="line">                obj.excGain = obj.strikeVig; <span class="comment">% strike vigor</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,97" id="srcline97"> 97</a></span><span class="line">                obj.m = (obj.strikeGain(length(obj.strikeGain))-obj.strikePos) / (length(obj.strikeGain)-1);</span></span>
<span class="srcline"><span class="lineno"><a href="30,98" id="srcline98"> 98</a></span><span class="line">                obj.strikeGain = obj.m * [1:length(obj.strikeGain)] + obj.strikePos - obj.m; <span class="comment">% (y=mx+b) strike postion</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,99" id="srcline99"> 99</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="30,100" id="srcline100">100</a></span><span class="line">                obj.buff(obj.instID,:) = f_bdwg(obj.modes(1:24)*obj.dimension, obj.decay(1:24), length(obj.buff(1,:)), obj.fs, [0.999; 1.001], 0.9, obj.strikeGain)'; <span class="comment">% banded waveguide</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,101" id="srcline101">101</a></span><span class="line">                <span class="comment">% waveguide mesh</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,102" id="srcline102">102</a></span><span class="line">                obj.buff(obj.instID,:) = ifft(real(fft(obj.buff(obj.instID,:))) .* real(fft(obj.resPadded(obj.instID,:)))); <span class="comment">% convolution with residual</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,103" id="srcline103">103</a></span><span class="line">                <span class="comment">%===================================</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,104" id="srcline104">104</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,105" id="srcline105">105</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,106" id="srcline106">106</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,107" id="srcline107">107</a></span><span class="line">            obj.noteState = val;</span></span>
<span class="srcline"><span class="lineno"><a href="30,108" id="srcline108">108</a></span><span class="line">        <span class="keyword">end</span> </span></span>
<span class="srcline"><span class="lineno"><a href="30,109" id="srcline109">109</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,110" id="srcline110">110</a></span><span class="line">        <span class="keyword">function</span> val = get.trig(obj)</span></span>
<span class="srcline"><span class="lineno"><a href="30,111" id="srcline111">111</a></span><span class="line">            val = obj.noteState;</span></span>
<span class="srcline"><span class="lineno"><a href="30,112" id="srcline112">112</a></span><span class="line">        <span class="keyword">end</span> </span></span>
<span class="srcline"><span class="lineno"><a href="30,113" id="srcline113">113</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,114" id="srcline114">114</a></span><span class="line">        <span class="keyword">function</span> out = process(obj, in) </span></span>
<span class="srcline"><span class="lineno"><a href="30,115" id="srcline115">115</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="30,116" id="srcline116">116</a></span><span class="line">            <span class="keyword">if</span> sum(obj.soundOut)&gt;0 <span class="comment">% do not process if all state variables are false</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,117" id="srcline117">117</a></span><span class="line">                <span class="keyword">for</span> i=1:length(obj.soundOut) <span class="comment">% iteration through synth buffers</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,118" id="srcline118">118</a></span><span class="line">                    <span class="keyword">if</span> obj.readIndex(i) &lt; length(obj.buff(i,:)) - length(in) <span class="comment">% buffer length not exceeded - add wavefrom</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,119" id="srcline119">119</a></span><span class="line">                        </span></span>
<span class="srcline"><span class="lineno"><a href="30,120" id="srcline120">120</a></span><span class="line">                        obj.frameBuff(1:length(in)) = obj.frameBuff(1:length(in))<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,121" id="srcline121">121</a></span><span class="line">                        + obj.buff(i,obj.readIndex(i):obj.readIndex(i)+(length(in)-1))<span class="keyword">...</span><span class="comment"> <span class="comment">% read from synth buffer, write to frame buffer</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="30,122" id="srcline122">122</a></span><span class="line">                        * obj.soundOut(i); <span class="comment">% applying state variable (only adding active instruments)</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,123" id="srcline123">123</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,124" id="srcline124">124</a></span><span class="line">                        obj.readIndex(i) = obj.readIndex(i) + length(in); <span class="comment">% increment readIndex by frame size</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,125" id="srcline125">125</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,126" id="srcline126">126</a></span><span class="line">                    <span class="keyword">else</span> <span class="comment">% buffer length exceeded - add zeros  </span></span></span>
<span class="srcline"><span class="lineno"><a href="30,127" id="srcline127">127</a></span><span class="line">                        obj.readIndex(i) = 1; <span class="comment">% init readIndex</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,128" id="srcline128">128</a></span><span class="line">                        obj.soundOut(i) = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="30,129" id="srcline129">129</a></span><span class="line">                    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,130" id="srcline130">130</a></span><span class="line">                <span class="keyword">end</span>    </span></span>
<span class="srcline"><span class="lineno"><a href="30,131" id="srcline131">131</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,132" id="srcline132">132</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="30,133" id="srcline133">133</a></span><span class="line">            out = (obj.frameBuff(1:length(in))*obj.excGain)'; <span class="comment">% output</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,134" id="srcline134">134</a></span><span class="line">            obj.frameBuff = zeros(1,length(obj.frameBuff)); <span class="comment">% clear frame buffer</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,135" id="srcline135">135</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,136" id="srcline136">136</a></span><span class="line">        <span class="keyword">end</span>  </span></span>
<span class="srcline"><span class="lineno"><a href="30,137" id="srcline137">137</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,138" id="srcline138">138</a></span><span class="line"><span class="comment">%--------------------------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,139" id="srcline139">139</a></span><span class="line">    <span class="keyword">methods</span> (Static)        </span></span>
<span class="srcline"><span class="lineno"><a href="30,140" id="srcline140">140</a></span><span class="line">        <span class="keyword">function</span> configureMIDI(obj,varargin)</span></span>
<span class="srcline"><span class="lineno"><a href="30,141" id="srcline141">141</a></span><span class="line">            <span class="comment">% Configure MIDI connections.</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,142" id="srcline142">142</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="30,143" id="srcline143">143</a></span><span class="line">            privConfigureMIDI(obj,varargin{:});</span></span>
<span class="srcline"><span class="lineno"><a href="30,144" id="srcline144">144</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,145" id="srcline145">145</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,146" id="srcline146">146</a></span><span class="line">        <span class="keyword">function</span> C = getMIDIConnections(obj)</span></span>
<span class="srcline"><span class="lineno"><a href="30,147" id="srcline147">147</a></span><span class="line">            <span class="comment">% Get MIDI connections. </span></span></span>
<span class="srcline"><span class="lineno"><a href="30,148" id="srcline148">148</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,149" id="srcline149">149</a></span><span class="line">            C = privConfigureMIDI(<span class="string">'getConnections'</span>,obj);</span></span>
<span class="srcline"><span class="lineno"><a href="30,150" id="srcline150">150</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,151" id="srcline151">151</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,152" id="srcline152">152</a></span><span class="line">        <span class="keyword">function</span> disconnectMIDI(obj)</span></span>
<span class="srcline"><span class="lineno"><a href="30,153" id="srcline153">153</a></span><span class="line">            <span class="comment">% Disconnect MIDI controls.</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,154" id="srcline154">154</a></span><span class="line">         </span></span>
<span class="srcline"><span class="lineno"><a href="30,155" id="srcline155">155</a></span><span class="line">            privConfigureMIDI(<span class="string">'disconnect'</span>,obj);       </span></span>
<span class="srcline"><span class="lineno"><a href="30,156" id="srcline156">156</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,157" id="srcline157">157</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,158" id="srcline158">158</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,159" id="srcline159">159</a></span><span class="line"><span class="comment">%--------------------------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,160" id="srcline160">160</a></span><span class="line"><span class="comment">%=================================== synth functions</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,161" id="srcline161">161</a></span><span class="line"><span class="keyword">function</span> out = bands(freq, time)</span></span>
<span class="srcline"><span class="lineno"><a href="30,162" id="srcline162">162</a></span><span class="line">    out = sin(2*pi*freq*time); </span></span>
<span class="srcline"><span class="lineno"><a href="30,163" id="srcline163">163</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
</div>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="30,164" id="srcline164">164</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,165" id="srcline165">165</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S75T12U975">out</span> = f_bdwg( <span class="var type1" id="S76T105U978">freqs</span>, <span class="var type1" id="S77T105U979">decay</span>, <span class="var type1" id="S78T3U980">Tsamp</span>, <span class="var type1" id="S79T3U981">fs</span>, <span class="var type2" id="S80T43V10U982">low_high</span>, <span class="var type1" id="S81T3U983">damp</span>, <span class="var type1" id="S82T13U984">bandCoeff</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="30,166" id="srcline166">166</a></span><span class="line">    <span class="comment">% Banded digital waveguide function</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,167" id="srcline167">167</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,168" id="srcline168">168</a></span><span class="line">    <span class="comment">%% variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,169" id="srcline169">169</a></span><span class="line">    <span class="mxinfo " id="T3:U9"><span class="var type1" id="S83T3U987">n_modes</span> = <span class="mxinfo " id="T3:U11">length(<span class="var type1" id="S76T105U990">freqs</span>)</span></span>; <span class="comment">% number of modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,170" id="srcline170">170</a></span><span class="line">    <span class="mxinfo " id="T105:U13"><span class="var type1" id="S85T105U993">d</span> = <span class="mxinfo " id="T105:U15">zeros(<span class="mxinfo " id="T3:U16">1</span>, <span class="var type1" id="S83T3U997">n_modes</span>)</span></span>; <span class="comment">% length of delay lines (Samples)</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,171" id="srcline171">171</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S87T3U1000">i</span> = <span class="mxinfo " id="T109:U19"><span class="mxinfo " id="T3:U20">1</span>:<span class="var type1" id="S83T3U1003">n_modes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="30,172" id="srcline172">172</a></span><span class="line">        <span class="mxinfo " id="T3:U22"><span class="mxinfo " id="T3:U23"><span class="var type1" id="S85T105U1007">d</span>(<span class="var type1" id="S87T3U1008">i</span>)</span> = <span class="mxinfo " id="T3:U26">floor(<span class="mxinfo " id="T3:U27"><span class="var type1" id="S79T3U1012">fs</span>/<span class="mxinfo " id="T3:U29"><span class="var type1" id="S76T105U1014">freqs</span>(<span class="var type1" id="S87T3U1015">i</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,173" id="srcline173">173</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,174" id="srcline174">174</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,175" id="srcline175">175</a></span><span class="line">    <span class="comment">%% initialization</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,176" id="srcline176">176</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,177" id="srcline177">177</a></span><span class="line">    <span class="mxinfo " id="T12:U32"><span class="var type1" id="S89T12U1018">L</span> = <span class="mxinfo " id="T12:U34">rand(1, <span class="mxinfo " id="T3:U35">max(<span class="var type1" id="S85T105U1024">d</span>)</span>)</span></span>; <span class="comment">% initialize delay lines with white noise</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,178" id="srcline178">178</a></span><span class="line">    <span class="mxinfo " id="T12:U37"><span class="var type1" id="S89T12U1027">L</span> = <span class="mxinfo " id="T12:U39"><span class="var type1" id="S89T12U1029">L</span> - <span class="mxinfo " id="T3:U41">mean(<span class="var type1" id="S89T12U1032">L</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,179" id="srcline179">179</a></span><span class="line">    <span class="mxinfo " id="T12:U43"><span class="var type1" id="S89T12U1035">L</span> = <span class="mxinfo " id="T12:U45"><span class="var type1" id="S89T12U1037">L</span>/<span class="mxinfo " id="T3:U47">max(<span class="var type1" id="S89T12U1040">L</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,180" id="srcline180">180</a></span><span class="line">    <span class="mxinfo " id="T110:U49"><span class="var type1" id="S89T110U1043">L</span> = <span class="mxinfo " id="T110:U51">repmat(<span class="var type1" id="S89T12U1046">L</span>,<span class="var type1" id="S83T3U1047">n_modes</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,181" id="srcline181">181</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="30,182" id="srcline182">182</a></span><span class="line">    <span class="mxinfo " id="T12:U54"><span class="var type1" id="S75T12U1051">out</span> = <span class="mxinfo " id="T12:U56">zeros(<span class="mxinfo " id="T3:U57">1</span>, <span class="var type1" id="S78T3U1055">Tsamp</span>)</span></span>; <span class="comment">% output</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,183" id="srcline183">183</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,184" id="srcline184">184</a></span><span class="line">    <span class="mxinfo " id="T105:U59"><span class="var type1" id="S94T105U1058">p_out</span> = <span class="mxinfo " id="T105:U61"><span class="mxinfo " id="T3:U62">3</span>*<span class="mxinfo " id="T105:U63">ones(<span class="mxinfo " id="T3:U64">1</span>,<span class="var type1" id="S83T3U1064">n_modes</span>)</span></span></span>; <span class="comment">% pointers out      (see shift register)</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,185" id="srcline185">185</a></span><span class="line">    <span class="mxinfo " id="T105:U66"><span class="var type1" id="S96T105U1067">p_out1</span> = <span class="mxinfo " id="T105:U68"><span class="mxinfo " id="T3:U69">2</span>*<span class="mxinfo " id="T105:U70">ones(<span class="mxinfo " id="T3:U71">1</span>,<span class="var type1" id="S83T3U1073">n_modes</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,186" id="srcline186">186</a></span><span class="line">    <span class="mxinfo " id="T105:U73"><span class="var type1" id="S97T105U1076">p_out2</span> = <span class="mxinfo " id="T105:U75"><span class="mxinfo " id="T3:U76">1</span>*<span class="mxinfo " id="T105:U77">ones(<span class="mxinfo " id="T3:U78">1</span>,<span class="var type1" id="S83T3U1082">n_modes</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,187" id="srcline187">187</a></span><span class="line">    <span class="comment">%p_out3 = 1*ones(1,n_modes);</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,188" id="srcline188">188</a></span><span class="line">    <span class="mxinfo " id="T105:U80"><span class="var type1" id="S98T105U1085">p_in</span> = <span class="mxinfo " id="T105:U82"><span class="mxinfo " id="T3:U83">6</span>*<span class="mxinfo " id="T105:U84">ones(<span class="mxinfo " id="T3:U85">1</span>,<span class="var type1" id="S83T3U1091">n_modes</span>)</span></span></span>; <span class="comment">% pointers in</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,189" id="srcline189">189</a></span><span class="line">    <span class="mxinfo " id="T105:U87"><span class="var type1" id="S99T105U1094">p_in1</span> = <span class="mxinfo " id="T105:U89"><span class="mxinfo " id="T3:U90">5</span>*<span class="mxinfo " id="T105:U91">ones(<span class="mxinfo " id="T3:U92">1</span>,<span class="var type1" id="S83T3U1100">n_modes</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,190" id="srcline190">190</a></span><span class="line">    <span class="mxinfo " id="T105:U94"><span class="var type1" id="S100T105U1103">p_in2</span> = <span class="mxinfo " id="T105:U96"><span class="mxinfo " id="T3:U97">4</span>*<span class="mxinfo " id="T105:U98">ones(<span class="mxinfo " id="T3:U99">1</span>,<span class="var type1" id="S83T3U1109">n_modes</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,191" id="srcline191">191</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,192" id="srcline192">192</a></span><span class="line">    <span class="comment">%% bandpass according to paper (following Steiglitz's DSP book, 1996)</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,193" id="srcline193">193</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,194" id="srcline194">194</a></span><span class="line">    <span class="mxinfo " id="T111:U101"><span class="var type1" id="S101T111U1112">f_low_high</span> = <span class="mxinfo " id="T111:U103"><span class="var type1" id="S80T43U1114">low_high</span>*<span class="var type1" id="S76T105U1115">freqs</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,195" id="srcline195">195</a></span><span class="line">    <span class="mxinfo " id="T105:U106"><span class="var type1" id="S102T105U1118">B</span> = <span class="mxinfo " id="T105:U108"><span class="mxinfo " id="T105:U109"><span class="var type1" id="S101T111U1121">f_low_high</span>(<span class="mxinfo " id="T19:U111">2</span>,<span class="mxinfo " id="T112:U112">:</span>)</span> - <span class="mxinfo " id="T105:U113"><span class="var type1" id="S101T111U1125">f_low_high</span>(<span class="mxinfo " id="T3:U115">1</span>,<span class="mxinfo " id="T112:U116">:</span>)</span></span></span>; <span class="comment">% bandwidth</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,196" id="srcline196">196</a></span><span class="line">    <span class="comment">% B = B';</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,197" id="srcline197">197</a></span><span class="line">    <span class="mxinfo " id="T105:U117"><span class="var type1" id="S103T105U1130">B_rad</span> = <span class="mxinfo " id="T105:U119"><span class="mxinfo " id="T3:U120"><span class="mxinfo " id="T3:U121">2*pi</span>/<span class="var type1" id="S79T3U1137">fs</span></span>*<span class="var type1" id="S102T105U1138">B</span></span></span>; <span class="comment">% bandwidth in radians/samp</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,198" id="srcline198">198</a></span><span class="line">    <span class="mxinfo " id="T105:U124"><span class="var type1" id="S105T105U1141">psi</span> = <span class="mxinfo " id="T105:U126"><span class="mxinfo " id="T3:U127"><span class="mxinfo " id="T3:U128">2*pi</span>/<span class="var type1" id="S79T3U1148">fs</span></span>*<span class="var type1" id="S76T105U1149">freqs</span></span></span>; <span class="comment">% center frequencies in radians/samp</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,199" id="srcline199">199</a></span><span class="line">    <span class="mxinfo " id="T105:U131"><span class="var type1" id="S106T105U1152">R</span> = <span class="mxinfo " id="T105:U133"><span class="mxinfo " id="T3:U134">1</span> - <span class="mxinfo " id="T105:U135"><span class="var type1" id="S103T105U1156">B_rad</span>/2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,200" id="srcline200">200</a></span><span class="line">    <span class="mxinfo " id="T105:U137"><span class="var type1" id="S107T105U1160">cosT</span> = <span class="mxinfo " id="T105:U139"><span class="mxinfo " id="T3:U140"><span class="mxinfo " id="T105:U141"><span class="mxinfo " id="T3:U142">2</span>*<span class="var type1" id="S106T105U1165">R</span></span>/(<span class="mxinfo " id="T105:U144"><span class="mxinfo " id="T3:U145">1</span>+<span class="mxinfo " id="T105:U146"><span class="var type1" id="S106T105U1170">R</span>.^2</span></span>)</span> * <span class="mxinfo " id="T105:U148">cos(<span class="var type1" id="S105T105U1174">psi</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,201" id="srcline201">201</a></span><span class="line">    <span class="mxinfo " id="T105:U150"><span class="var type1" id="S109T105U1177">A0</span> = <span class="mxinfo " id="T105:U152">(<span class="mxinfo " id="T105:U153"><span class="mxinfo " id="T3:U154">1</span>-<span class="mxinfo " id="T105:U155"><span class="var type1" id="S106T105U1183">R</span>.^2</span></span>)/2</span></span>; <span class="comment">% normalization scale factor or gain adjustment</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,202" id="srcline202">202</a></span><span class="line">    <span class="comment">% A0 = sqrt(A0);</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,203" id="srcline203">203</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,204" id="srcline204">204</a></span><span class="line">    <span class="comment">% a and b coefficients</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,205" id="srcline205">205</a></span><span class="line">    <span class="mxinfo " id="T113:U157"><span class="var type1" id="S110T113U1188">a</span> = <span class="mxinfo " id="T113:U159">zeros(<span class="var type1" id="S83T3U1191">n_modes</span>, <span class="mxinfo " id="T3:U161">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,206" id="srcline206">206</a></span><span class="line">    <span class="mxinfo " id="T113:U162"><span class="var type1" id="S111T113U1195">b</span> = <span class="mxinfo " id="T113:U164">zeros(<span class="var type1" id="S83T3U1198">n_modes</span>, <span class="mxinfo " id="T3:U166">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,207" id="srcline207">207</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S87T3U1202">i</span> = <span class="mxinfo " id="T109:U168"><span class="mxinfo " id="T3:U169">1</span>:<span class="var type1" id="S83T3U1205">n_modes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="30,208" id="srcline208">208</a></span><span class="line">        <span class="mxinfo " id="T114:U171"><span class="mxinfo " id="T114:U172"><span class="var type1" id="S111T113U1209">b</span>(<span class="var type1" id="S87T3U1210">i</span>,<span class="mxinfo " id="T115:U175">:</span>)</span> = <span class="mxinfo " id="T114:U176">[<span class="mxinfo " id="T3:U177"><span class="var type1" id="S109T105U1215">A0</span>(<span class="var type1" id="S87T3U1216">i</span>)</span>, <span class="mxinfo " id="T3:U180">0</span>, <span class="mxinfo " id="T3:U181">-<span class="mxinfo " id="T3:U182"><span class="var type1" id="S109T105U1220">A0</span>(<span class="var type1" id="S87T3U1221">i</span>)</span></span>]</span></span>; <span class="comment">% b coeff dependent of scaling gain factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,209" id="srcline209">209</a></span><span class="line">        <span class="mxinfo " id="T114:U185"><span class="mxinfo " id="T114:U186"><span class="var type1" id="S110T113U1225">a</span>(<span class="var type1" id="S87T3U1226">i</span>,<span class="mxinfo " id="T115:U189">:</span>)</span> = <span class="mxinfo " id="T114:U190">[<span class="mxinfo " id="T3:U191">1</span>, <span class="mxinfo " id="T3:U192"><span class="mxinfo " id="T3:U193"><span class="mxinfo " id="T3:U194">-<span class="mxinfo " id="T3:U195">2</span></span>*<span class="mxinfo " id="T3:U196"><span class="var type1" id="S106T105U1236">R</span>(<span class="var type1" id="S87T3U1237">i</span>)</span></span>*<span class="mxinfo " id="T3:U199"><span class="var type1" id="S107T105U1239">cosT</span>(<span class="var type1" id="S87T3U1240">i</span>)</span></span>, <span class="mxinfo " id="T3:U202"><span class="mxinfo " id="T3:U203"><span class="var type1" id="S106T105U1243">R</span>(<span class="var type1" id="S87T3U1244">i</span>)</span>^2</span>]</span></span>; <span class="comment">% a coeff depending on R and cosT     </span></span></span>
<span class="srcline"><span class="lineno"><a href="30,210" id="srcline210">210</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,211" id="srcline211">211</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,212" id="srcline212">212</a></span><span class="line">    <span class="comment">% a = zeros(n_modes, 4);</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,213" id="srcline213">213</a></span><span class="line">    <span class="comment">% b = zeros(n_modes, 3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,214" id="srcline214">214</a></span><span class="line">    <span class="comment">% for i = 1:n_modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,215" id="srcline215">215</a></span><span class="line">    <span class="comment">%     u = 2*R(i)*cosT(i);</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,216" id="srcline216">216</a></span><span class="line">    <span class="comment">%     v = R(i)^2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,217" id="srcline217">217</a></span><span class="line">    <span class="comment">%     b(i,:) = [A0(i)*(1-damp), 0, -A0(i)*(1-damp)]; % b coeff dependent of scaling gain factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,218" id="srcline218">218</a></span><span class="line">    <span class="comment">%     a(i,:) = [1, -(u+damp), v+u*damp, -v*damp]; % a coeff depending on R and cosT     </span></span></span>
<span class="srcline"><span class="lineno"><a href="30,219" id="srcline219">219</a></span><span class="line">    <span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,220" id="srcline220">220</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,221" id="srcline221">221</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,222" id="srcline222">222</a></span><span class="line">    <span class="comment">%% main loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,223" id="srcline223">223</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,224" id="srcline224">224</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S87T3U1248">i</span>=<span class="mxinfo " id="T18:U207"><span class="mxinfo " id="T3:U208">1</span>:<span class="var type1" id="S78T3U1251">Tsamp</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="30,225" id="srcline225">225</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,226" id="srcline226">226</a></span><span class="line">        <span class="mxinfo " id="T3:U210"><span class="mxinfo " id="T3:U211"><span class="var type1" id="S75T12U1255">out</span>(<span class="var type1" id="S87T3U1256">i</span>)</span> = <span class="mxinfo " id="T3:U214">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,227" id="srcline227">227</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,228" id="srcline228">228</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S112T3U1260">j</span> = <span class="mxinfo " id="T109:U216"><span class="mxinfo " id="T3:U217">1</span>:<span class="var type1" id="S83T3U1263">n_modes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="30,229" id="srcline229">229</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="30,230" id="srcline230">230</a></span><span class="line">            <span class="comment">% bandpass filter y[n] = b1*x[n] + b2*x[n-1] + b3*x[n-2] - a2*y[n-1] - a3*y[n-2]</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,231" id="srcline231">231</a></span><span class="line">            <span class="mxinfo " id="T3:U219"><span class="mxinfo " id="T3:U220"><span class="var type1" id="S89T110U1267">L</span>(<span class="var type1" id="S112T3U1268">j</span>, <span class="mxinfo " id="T3:U223"><span class="var type1" id="S94T105U1270">p_out</span>(<span class="var type1" id="S112T3U1271">j</span>)</span>)</span> = <span class="mxinfo " id="T3:U226"><span class="mxinfo " id="T3:U227"><span class="var type1" id="S77T105U1274">decay</span>(<span class="var type1" id="S112T3U1275">j</span>)</span> * (<span class="mxinfo " id="T3:U230"><span class="mxinfo " id="T3:U231"><span class="mxinfo " id="T3:U232"><span class="mxinfo " id="T3:U233"><span class="mxinfo " id="T3:U234"><span class="var type1" id="S111T113U1282">b</span>(<span class="var type1" id="S112T3U1283">j</span>,<span class="mxinfo " id="T3:U237">1</span>)</span>*<span class="mxinfo " id="T3:U238"><span class="var type1" id="S89T110U1286">L</span>(<span class="var type1" id="S112T3U1287">j</span>, <span class="mxinfo " id="T3:U241"><span class="var type1" id="S98T105U1289">p_in</span>(<span class="var type1" id="S112T3U1290">j</span>)</span>)</span></span> + <span class="keyword">...</span><span class="comment">                               <span class="comment">% b(j,2)*L(j, p_in1(j))... (=0)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="30,232" id="srcline232">232</a></span><span class="line">                <span class="mxinfo " id="T3:U244"><span class="mxinfo " id="T3:U245">+ <span class="mxinfo " id="T3:U246"><span class="var type1" id="S111T113U1294">b</span>(<span class="var type1" id="S112T3U1295">j</span>,<span class="mxinfo " id="T3:U249">3</span>)</span></span>*<span class="mxinfo " id="T3:U250"><span class="var type1" id="S89T110U1298">L</span>(<span class="var type1" id="S112T3U1299">j</span>, <span class="mxinfo " id="T3:U253"><span class="var type1" id="S100T105U1301">p_in2</span>(<span class="var type1" id="S112T3U1302">j</span>)</span>)</span></span></span> - <span class="mxinfo " id="T3:U256"><span class="mxinfo " id="T3:U257"><span class="var type1" id="S110T113U1305">a</span>(<span class="var type1" id="S112T3U1306">j</span>,<span class="mxinfo " id="T3:U260">2</span>)</span>*<span class="mxinfo " id="T3:U261"><span class="var type1" id="S89T110U1309">L</span>(<span class="var type1" id="S112T3U1310">j</span>, <span class="mxinfo " id="T3:U264"><span class="var type1" id="S96T105U1312">p_out1</span>(<span class="var type1" id="S112T3U1313">j</span>)</span>)</span></span></span> - <span class="mxinfo " id="T3:U267"><span class="mxinfo " id="T3:U268"><span class="var type1" id="S110T113U1316">a</span>(<span class="var type1" id="S112T3U1317">j</span>,<span class="mxinfo " id="T3:U271">3</span>)</span>*<span class="mxinfo " id="T3:U272"><span class="var type1" id="S89T110U1320">L</span>(<span class="var type1" id="S112T3U1321">j</span>, <span class="mxinfo " id="T3:U275"><span class="var type1" id="S97T105U1323">p_out2</span>(<span class="var type1" id="S112T3U1324">j</span>)</span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,233" id="srcline233">233</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="30,234" id="srcline234">234</a></span><span class="line">    <span class="comment">%         L(j, p_out(j)) = b(j,1)*L(j, p_in(j)) + b(j,3)*L(j, p_in2(j))<span class="keyword">...</span><span class="comment">                      % b(j,2)*L(j, p_in1(j))... (=0)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="30,235" id="srcline235">235</a></span><span class="line">    <span class="comment">%              - a(j,2)*L(j, p_out1(j)) - a(j,3)*L(j, p_out2(j)) - a(j,4)*L(j, p_out3(j));</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,236" id="srcline236">236</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="30,237" id="srcline237">237</a></span><span class="line">            <span class="mxinfo " id="T3:U278"><span class="mxinfo " id="T3:U279"><span class="var type1" id="S75T12U1328">out</span>(<span class="var type1" id="S87T3U1329">i</span>)</span> = <span class="mxinfo " id="T3:U282"><span class="mxinfo " id="T3:U283"><span class="var type1" id="S75T12U1332">out</span>(<span class="var type1" id="S87T3U1333">i</span>)</span> + <span class="mxinfo " id="T3:U286"><span class="mxinfo " id="T3:U287"><span class="var type1" id="S89T110U1336">L</span>(<span class="var type1" id="S112T3U1337">j</span>,<span class="mxinfo " id="T3:U290"><span class="var type1" id="S94T105U1339">p_out</span>(<span class="var type1" id="S112T3U1340">j</span>)</span>)</span>*<span class="mxinfo " id="T3:U293"><span class="var type1" id="S82T13U1342">bandCoeff</span>(<span class="var type1" id="S112T3U1343">j</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,238" id="srcline238">238</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="30,239" id="srcline239">239</a></span><span class="line">            <span class="comment">% update and wrap pointers</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,240" id="srcline240">240</a></span><span class="line">            <span class="keyword">if</span> (<span class="mxinfo " id="T7:U296"><span class="mxinfo " id="T3:U297"><span class="var type1" id="S98T105U1349">p_in</span>(<span class="var type1" id="S112T3U1350">j</span>)</span>==<span class="mxinfo " id="T3:U300"><span class="var type1" id="S85T105U1352">d</span>(<span class="var type1" id="S112T3U1353">j</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="30,241" id="srcline241">241</a></span><span class="line">                <span class="mxinfo " id="T3:U303"><span class="mxinfo " id="T3:U304"><span class="var type1" id="S98T105U1357">p_in</span>(<span class="var type1" id="S112T3U1358">j</span>)</span>=<span class="mxinfo " id="T3:U307">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,242" id="srcline242">242</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,243" id="srcline243">243</a></span><span class="line">                <span class="mxinfo " id="T3:U308"><span class="mxinfo " id="T3:U309"><span class="var type1" id="S98T105U1364">p_in</span>(<span class="var type1" id="S112T3U1365">j</span>)</span>=<span class="mxinfo " id="T3:U312"><span class="mxinfo " id="T3:U313"><span class="var type1" id="S98T105U1368">p_in</span>(<span class="var type1" id="S112T3U1369">j</span>)</span>+<span class="mxinfo " id="T3:U316">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,244" id="srcline244">244</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,245" id="srcline245">245</a></span><span class="line">            <span class="keyword">if</span> (<span class="mxinfo " id="T7:U317"><span class="mxinfo " id="T3:U318"><span class="var type1" id="S99T105U1376">p_in1</span>(<span class="var type1" id="S112T3U1377">j</span>)</span>==<span class="mxinfo " id="T3:U321"><span class="var type1" id="S85T105U1379">d</span>(<span class="var type1" id="S112T3U1380">j</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="30,246" id="srcline246">246</a></span><span class="line">                <span class="mxinfo " id="T3:U324"><span class="mxinfo " id="T3:U325"><span class="var type1" id="S99T105U1384">p_in1</span>(<span class="var type1" id="S112T3U1385">j</span>)</span>=<span class="mxinfo " id="T3:U328">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,247" id="srcline247">247</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,248" id="srcline248">248</a></span><span class="line">                <span class="mxinfo " id="T3:U329"><span class="mxinfo " id="T3:U330"><span class="var type1" id="S99T105U1391">p_in1</span>(<span class="var type1" id="S112T3U1392">j</span>)</span>=<span class="mxinfo " id="T3:U333"><span class="mxinfo " id="T3:U334"><span class="var type1" id="S99T105U1395">p_in1</span>(<span class="var type1" id="S112T3U1396">j</span>)</span>+<span class="mxinfo " id="T3:U337">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,249" id="srcline249">249</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,250" id="srcline250">250</a></span><span class="line">            <span class="keyword">if</span> (<span class="mxinfo " id="T7:U338"><span class="mxinfo " id="T3:U339"><span class="var type1" id="S100T105U1403">p_in2</span>(<span class="var type1" id="S112T3U1404">j</span>)</span>==<span class="mxinfo " id="T3:U342"><span class="var type1" id="S85T105U1406">d</span>(<span class="var type1" id="S112T3U1407">j</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="30,251" id="srcline251">251</a></span><span class="line">                <span class="mxinfo " id="T3:U345"><span class="mxinfo " id="T3:U346"><span class="var type1" id="S100T105U1411">p_in2</span>(<span class="var type1" id="S112T3U1412">j</span>)</span>=<span class="mxinfo " id="T3:U349">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,252" id="srcline252">252</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,253" id="srcline253">253</a></span><span class="line">                <span class="mxinfo " id="T3:U350"><span class="mxinfo " id="T3:U351"><span class="var type1" id="S100T105U1418">p_in2</span>(<span class="var type1" id="S112T3U1419">j</span>)</span>=<span class="mxinfo " id="T3:U354"><span class="mxinfo " id="T3:U355"><span class="var type1" id="S100T105U1422">p_in2</span>(<span class="var type1" id="S112T3U1423">j</span>)</span>+<span class="mxinfo " id="T3:U358">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,254" id="srcline254">254</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,255" id="srcline255">255</a></span><span class="line">            <span class="keyword">if</span> (<span class="mxinfo " id="T7:U359"><span class="mxinfo " id="T3:U360"><span class="var type1" id="S94T105U1430">p_out</span>(<span class="var type1" id="S112T3U1431">j</span>)</span>==<span class="mxinfo " id="T3:U363"><span class="var type1" id="S85T105U1433">d</span>(<span class="var type1" id="S112T3U1434">j</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="30,256" id="srcline256">256</a></span><span class="line">                <span class="mxinfo " id="T3:U366"><span class="mxinfo " id="T3:U367"><span class="var type1" id="S94T105U1438">p_out</span>(<span class="var type1" id="S112T3U1439">j</span>)</span>=<span class="mxinfo " id="T3:U370">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,257" id="srcline257">257</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,258" id="srcline258">258</a></span><span class="line">                <span class="mxinfo " id="T3:U371"><span class="mxinfo " id="T3:U372"><span class="var type1" id="S94T105U1445">p_out</span>(<span class="var type1" id="S112T3U1446">j</span>)</span>=<span class="mxinfo " id="T3:U375"><span class="mxinfo " id="T3:U376"><span class="var type1" id="S94T105U1449">p_out</span>(<span class="var type1" id="S112T3U1450">j</span>)</span>+<span class="mxinfo " id="T3:U379">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,259" id="srcline259">259</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,260" id="srcline260">260</a></span><span class="line">            <span class="keyword">if</span> (<span class="mxinfo " id="T7:U380"><span class="mxinfo " id="T3:U381"><span class="var type1" id="S96T105U1457">p_out1</span>(<span class="var type1" id="S112T3U1458">j</span>)</span>==<span class="mxinfo " id="T3:U384"><span class="var type1" id="S85T105U1460">d</span>(<span class="var type1" id="S112T3U1461">j</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="30,261" id="srcline261">261</a></span><span class="line">                <span class="mxinfo " id="T3:U387"><span class="mxinfo " id="T3:U388"><span class="var type1" id="S96T105U1465">p_out1</span>(<span class="var type1" id="S112T3U1466">j</span>)</span>=<span class="mxinfo " id="T3:U391">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,262" id="srcline262">262</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,263" id="srcline263">263</a></span><span class="line">                <span class="mxinfo " id="T3:U392"><span class="mxinfo " id="T3:U393"><span class="var type1" id="S96T105U1472">p_out1</span>(<span class="var type1" id="S112T3U1473">j</span>)</span>=<span class="mxinfo " id="T3:U396"><span class="mxinfo " id="T3:U397"><span class="var type1" id="S96T105U1476">p_out1</span>(<span class="var type1" id="S112T3U1477">j</span>)</span>+<span class="mxinfo " id="T3:U400">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,264" id="srcline264">264</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,265" id="srcline265">265</a></span><span class="line">            <span class="keyword">if</span> (<span class="mxinfo " id="T7:U401"><span class="mxinfo " id="T3:U402"><span class="var type1" id="S97T105U1484">p_out2</span>(<span class="var type1" id="S112T3U1485">j</span>)</span>==<span class="mxinfo " id="T3:U405"><span class="var type1" id="S85T105U1487">d</span>(<span class="var type1" id="S112T3U1488">j</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="30,266" id="srcline266">266</a></span><span class="line">                <span class="mxinfo " id="T3:U408"><span class="mxinfo " id="T3:U409"><span class="var type1" id="S97T105U1492">p_out2</span>(<span class="var type1" id="S112T3U1493">j</span>)</span>=<span class="mxinfo " id="T3:U412">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,267" id="srcline267">267</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,268" id="srcline268">268</a></span><span class="line">                <span class="mxinfo " id="T3:U413"><span class="mxinfo " id="T3:U414"><span class="var type1" id="S97T105U1499">p_out2</span>(<span class="var type1" id="S112T3U1500">j</span>)</span>=<span class="mxinfo " id="T3:U417"><span class="mxinfo " id="T3:U418"><span class="var type1" id="S97T105U1503">p_out2</span>(<span class="var type1" id="S112T3U1504">j</span>)</span>+<span class="mxinfo " id="T3:U421">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,269" id="srcline269">269</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,270" id="srcline270">270</a></span><span class="line">    <span class="comment">%         if (p_out3(j)==d(j))</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,271" id="srcline271">271</a></span><span class="line">    <span class="comment">%             p_out3(j)=1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,272" id="srcline272">272</a></span><span class="line">    <span class="comment">%         else</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,273" id="srcline273">273</a></span><span class="line">    <span class="comment">%             p_out3(j)=p_out3(j)+1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,274" id="srcline274">274</a></span><span class="line">    <span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,275" id="srcline275">275</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="30,276" id="srcline276">276</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,277" id="srcline277">277</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="30,278" id="srcline278">278</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,279" id="srcline279">279</a></span><span class="line">    <span class="mxinfo " id="T12:U422"><span class="var type1" id="S75T12U1508">out</span> = <span class="mxinfo " id="T12:U424"><span class="var type1" id="S75T12U1510">out</span> / <span class="mxinfo " id="T3:U426">max(<span class="var type1" id="S75T12U1513">out</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="30,280" id="srcline280">280</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="30,281" id="srcline281">281</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="30,282" id="srcline282">282</a></span><span class="line"><span class="comment">%===================================</span></span></span>
</pre>
</div>
